name: Deploy Visitor Kiosk to Linode

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code (include submodules if any)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Install sshpass
        run: sudo apt-get update -qq && sudo apt-get install -y -qq sshpass

      - name: Verify repo contents (runner)
        run: |
          set -e
          echo "Workspace: $(pwd)"
          echo "Top-level:"
          ls -la

          echo "Frontend:"
          ls -la fe || true
          ls -la fe/package.json fe/package-lock.json

          echo "Backend (optional):"
          if [ -d "be" ]; then
            ls -la be
            ls -la be/package.json be/package-lock.json
          else
            echo "NOTE: 'be/' folder is NOT present in this repo checkout."
          fi

      # Copy ONLY frontend + deploy configs so we don't accidentally delete /root/VisitorKiosk/be on the server
      - name: Copy FE + deploy files to Linode
        run: |
          # Ensure target folders exist
          sshpass -p "jS21goUi0267" ssh -o StrictHostKeyChecking=no root@172.232.20.177 "mkdir -p /root/VisitorKiosk/fe"

          # Sync frontend only (safe to --delete within fe)
          rsync -avz --delete \
            --exclude '.git' \
            --exclude 'node_modules' \
            --exclude '.env' \
            ./fe/ root@172.232.20.177:/root/VisitorKiosk/fe/
          
          # Sync deploy/config files (no --delete)
          rsync -avz \
            ./visitorkiosk.conf \
            ./visitorkiosk-be.service \
            ./visitorkiosk-fe.service \
            root@172.232.20.177:/root/VisitorKiosk/
        env:
          RSYNC_RSH: 'sshpass -p "jS21goUi0267" ssh -o StrictHostKeyChecking=no'

      - name: Build and restart on Linode
        uses: appleboy/ssh-action@master
        with:
          host: "172.232.20.177"
          username: "root"
          password: "jS21goUi0267"
          script: |
            set -e
            export DEBIAN_FRONTEND=noninteractive

            # Ensure base packages exist
            apt update -qq
            apt install -y -qq nginx

            # Ensure node/npm exist (skip if already installed)
            if ! command -v npm >/dev/null 2>&1; then
              apt install -y -qq ca-certificates curl gnupg
              curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
              apt install -y -qq nodejs
            fi

            node -v
            npm -v

            # -------------------------
            # Backend (ONLY if present on server)
            # -------------------------
            if [ -f /root/VisitorKiosk/be/package.json ]; then
              cd /root/VisitorKiosk/be
              echo "BE PWD=$(pwd)"
              ls -la package.json || true

              if [ ! -f package-lock.json ] && [ ! -f npm-shrinkwrap.json ]; then
                echo "ERROR: Backend exists but no package-lock.json in /root/VisitorKiosk/be. Cannot run npm ci."
                exit 1
              fi

              npm ci
              npm run build

              # Install/Update systemd service
              rm -f /etc/systemd/system/visitorkiosk-be.service
              cp /root/VisitorKiosk/visitorkiosk-be.service /etc/systemd/system/visitorkiosk-be.service
              chmod 644 /etc/systemd/system/visitorkiosk-be.service

              systemctl daemon-reload
              systemctl enable visitorkiosk-be.service
              systemctl restart visitorkiosk-be.service
            else
              echo "NOTE: Backend not found at /root/VisitorKiosk/be. Skipping backend build/restart."
            fi

            # -------------------------
            # Frontend
            # -------------------------
            cd /root/VisitorKiosk/fe
            echo "FE PWD=$(pwd)"
            ls -la package.json package-lock.json

            npm ci
            npm run build

            # Copy FE build to nginx-readable directory
            rm -rf /var/www/visitorkiosk
            mkdir -p /var/www/visitorkiosk
            cp -r /root/VisitorKiosk/fe/dist/* /var/www/visitorkiosk/
            chown -R www-data:www-data /var/www/visitorkiosk

            # -------------------------
            # Nginx
            # -------------------------
            rm -f /etc/nginx/sites-available/visitorkiosk.conf
            rm -f /etc/nginx/sites-enabled/visitorkiosk.conf
            cp /root/VisitorKiosk/visitorkiosk.conf /etc/nginx/sites-available/visitorkiosk.conf
            ln -s /etc/nginx/sites-available/visitorkiosk.conf /etc/nginx/sites-enabled/visitorkiosk.conf

            nginx -t
            systemctl reload nginx

            # Show BE status if it exists
            systemctl status visitorkiosk-be.service -l --no-pager || true
