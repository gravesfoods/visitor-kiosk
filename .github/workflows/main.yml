name: Deploy Visitor Kiosk to Linode

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install sshpass
        run: sudo apt-get update -qq && sudo apt-get install -y -qq sshpass

      - name: Validate required folders + lockfiles exist in repo checkout
        run: |
          set -e
          test -f fe/package.json
          test -f fe/package-lock.json
          test -f be/package.json
          test -f be/package-lock.json
          test -f visitorkiosk-be.service
          test -f visitorkiosk-fe.service
          echo "OK: repo has be/, fe/, lockfiles, and service files."

      - name: Copy BE + FE to Linode
        run: |
          sshpass -p "jS21goUi0267" ssh -o StrictHostKeyChecking=no root@172.232.20.177 \
            "mkdir -p /root/VisitorKiosk/be /root/VisitorKiosk/fe"

          rsync -avz --delete \
            --exclude '.git' \
            --exclude 'node_modules' \
            --exclude '.env' \
            ./be/ root@172.232.20.177:/root/VisitorKiosk/be/

          rsync -avz --delete \
            --exclude '.git' \
            --exclude 'node_modules' \
            --exclude '.env' \
            ./fe/ root@172.232.20.177:/root/VisitorKiosk/fe/

          rsync -avz \
            ./visitorkiosk-be.service \
            ./visitorkiosk-fe.service \
            root@172.232.20.177:/root/VisitorKiosk/
        env:
          RSYNC_RSH: 'sshpass -p "jS21goUi0267" ssh -o StrictHostKeyChecking=no'

      - name: Build and restart on Linode
        uses: appleboy/ssh-action@master
        with:
          host: "172.232.20.177"
          username: "root"
          password: "jS21goUi0267"
          script: |
            set -e
            export DEBIAN_FRONTEND=noninteractive

            apt update -qq
            apt install -y -qq nginx

            # Ensure node/npm exist
            if ! command -v npm >/dev/null 2>&1; then
              apt install -y -qq ca-certificates curl gnupg
              curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
              apt install -y -qq nodejs
            fi

            node -v
            npm -v

            # -------------------------
            # Backend
            # -------------------------
            cd /root/VisitorKiosk/be
            npm ci
            npm run build

            rm -f /etc/systemd/system/visitorkiosk-be.service
            cp /root/VisitorKiosk/visitorkiosk-be.service /etc/systemd/system/visitorkiosk-be.service
            chmod 644 /etc/systemd/system/visitorkiosk-be.service

            systemctl daemon-reload
            systemctl enable visitorkiosk-be.service
            systemctl restart visitorkiosk-be.service

            # -------------------------
            # Frontend
            # -------------------------
            cd /root/VisitorKiosk/fe
            npm ci
            npm run build

            # (Optional) Keep this if you also serve static somewhere. Harmless otherwise.
            rm -rf /var/www/visitorkiosk
            mkdir -p /var/www/visitorkiosk
            cp -r /root/VisitorKiosk/fe/dist/* /var/www/visitorkiosk/
            chown -R www-data:www-data /var/www/visitorkiosk

            # Install/Update FE systemd service + restart
            rm -f /etc/systemd/system/visitorkiosk-fe.service
            cp /root/VisitorKiosk/visitorkiosk-fe.service /etc/systemd/system/visitorkiosk-fe.service
            chmod 644 /etc/systemd/system/visitorkiosk-fe.service

            systemctl daemon-reload
            systemctl enable visitorkiosk-fe.service
            systemctl restart visitorkiosk-fe.service

            # -------------------------
            # Nginx (use existing server conf)
            # -------------------------
            if [ ! -f /root/VisitorKiosk/visitorkiosk.conf ]; then
              echo "ERROR: /root/VisitorKiosk/visitorkiosk.conf not found on server."
              exit 1
            fi

            rm -f /etc/nginx/sites-available/visitorkiosk.conf
            rm -f /etc/nginx/sites-enabled/visitorkiosk.conf
            cp /root/VisitorKiosk/visitorkiosk.conf /etc/nginx/sites-available/visitorkiosk.conf
            ln -s /etc/nginx/sites-available/visitorkiosk.conf /etc/nginx/sites-enabled/visitorkiosk.conf

            nginx -t
            systemctl reload nginx

            systemctl status visitorkiosk-be.service -l --no-pager
            systemctl status visitorkiosk-fe.service -l --no-pager
