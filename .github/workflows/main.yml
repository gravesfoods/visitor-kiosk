name: Deploy Visitor Kiosk to Linode

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code (include submodules if any)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Install sshpass
        run: sudo apt-get update -qq && sudo apt-get install -y -qq sshpass

      # Fail fast so we don't rsync --delete and accidentally remove server folders
      - name: Validate required folders + lockfiles exist in repo checkout
        run: |
          set -e
          echo "Workspace: $(pwd)"
          ls -la

          echo "Checking FE..."
          test -f fe/package.json
          test -f fe/package-lock.json

          echo "Checking BE..."
          test -f be/package.json
          test -f be/package-lock.json

          echo "OK: be/ and fe/ exist and have package-lock.json"

      - name: Copy BE + FE to Linode (safe per-folder sync)
        run: |
          # Ensure target dirs exist
          sshpass -p "jS21goUi0267" ssh -o StrictHostKeyChecking=no root@172.232.20.177 \
            "mkdir -p /root/VisitorKiosk/be /root/VisitorKiosk/fe"

          # Sync backend only
          rsync -avz --delete \
            --exclude '.git' \
            --exclude 'node_modules' \
            --exclude '.env' \
            ./be/ root@172.232.20.177:/root/VisitorKiosk/be/

          # Sync frontend only
          rsync -avz --delete \
            --exclude '.git' \
            --exclude 'node_modules' \
            --exclude '.env' \
            ./fe/ root@172.232.20.177:/root/VisitorKiosk/fe/

          # Sync deploy files (no --delete)
          rsync -avz \
            ./visitorkiosk.conf \
            ./visitorkiosk-be.service \
            ./visitorkiosk-fe.service \
            root@172.232.20.177:/root/VisitorKiosk/
        env:
          RSYNC_RSH: 'sshpass -p "jS21goUi0267" ssh -o StrictHostKeyChecking=no'

      - name: Build and restart on Linode
        uses: appleboy/ssh-action@master
        with:
          host: "172.232.20.177"
          username: "root"
          password: "jS21goUi0267"
          script: |
            set -e
            export DEBIAN_FRONTEND=noninteractive

            # Ensure base packages exist
            apt update -qq
            apt install -y -qq nginx

            # Ensure node/npm exist
            if ! command -v npm >/dev/null 2>&1; then
              apt install -y -qq ca-certificates curl gnupg
              curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
              apt install -y -qq nodejs
            fi

            node -v
            npm -v

            # -------------------------
            # Backend
            # -------------------------
            cd /root/VisitorKiosk/be
            ls -la package.json package-lock.json
            npm ci
            npm run build

            # Install/Update systemd service
            rm -f /etc/systemd/system/visitorkiosk-be.service
            cp /root/VisitorKiosk/visitorkiosk-be.service /etc/systemd/system/visitorkiosk-be.service
            chmod 644 /etc/systemd/system/visitorkiosk-be.service

            systemctl daemon-reload
            systemctl enable visitorkiosk-be.service
            systemctl restart visitorkiosk-be.service

            # -------------------------
            # Frontend
            # -------------------------
            cd /root/VisitorKiosk/fe
            ls -la package.json package-lock.json
            npm ci
            npm run build

            # Copy FE build to nginx-readable directory
            rm -rf /var/www/visitorkiosk
            mkdir -p /var/www/visitorkiosk
            cp -r /root/VisitorKiosk/fe/dist/* /var/www/visitorkiosk/
            chown -R www-data:www-data /var/www/visitorkiosk

            # -------------------------
            # Nginx
            # -------------------------
            rm -f /etc/nginx/sites-available/visitorkiosk.conf
            rm -f /etc/nginx/sites-enabled/visitorkiosk.conf
            cp /root/VisitorKiosk/visitorkiosk.conf /etc/nginx/sites-available/visitorkiosk.conf
            ln -s /etc/nginx/sites-available/visitorkiosk.conf /etc/nginx/sites-enabled/visitorkiosk.conf

            nginx -t
            systemctl reload nginx

            systemctl status visitorkiosk-be.service -l --no-pager
